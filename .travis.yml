branches:
  only:
    - develop
    - enable-travis-bionic-build

language: cpp

cache:
  directories:
    - /var/cache/ccache

dist: bionic

addons:
  apt:
    update: true
    sources:
      - sourceline: 'ppa:onedata/build-deps-1802'
    packages:
      - autoconf
      - aws-sdk-cpp-s3
      - bash-completion
      - bc
      - build-essential
      - ccache
      - cmake
      - curl
      - debhelper
      - devscripts
      - doxygen
      - folly
      - folly-dev
      - fuse
      - g++
      - gdb
      - git
      - glusterfs-common
      - glusterfs-dbg
      - golang-go
      - iputils-ping
      - jekyll
      - lcov
      - libacl1
      - libacl1-dev
      - libboost-all-dev
      - libboost-context1.65.1
      - libboost-filesystem1.65.1
      - libboost-iostreams1.65.1
      - libboost-log1.65.1
      - libboost-program-options1.65.1
      - libboost-python1.65.1
      - libboost-random1.65.1
      - libboost-system1.65.1
      - libboost-thread1.65.1
      - libbotan1.10
      - libbotan1.10-dev
      - libcurl4
      - libcurl4-openssl-dev
      - libdouble-conversion1
      - libfuse-dev
      - libgflags-dev
      - libgflags2.2
      - libgoogle-glog-dev
      - libgoogle-glog0v5
      - libgoogle-perftools-dev
      - libgoogle-perftools4
      - libiberty-dev
      - libjemalloc-dev
      - libjemalloc1
      - libltdl-dev
      - libnspr4
      - libnspr4-dev
      - libnss3
      - libnss3-dev
      - libpoco-dev
      - libpocofoundation50
      - libpoconetssl50
      - libpocoutil50
      - libpocoxml50
      - libprotobuf-dev
      - libprotobuf10
      - librados-dev
      - librados2
      - libradosstriper-dev
      - libradosstriper1
      - libsodium-dev
      - libsodium23
      - libstdc++-7-dev
      - libtbb-dev
      - libtbb2
      - libunwind-dev
      - libunwind8
      - locales
      - nano
      - nfs-common
      - ninja-build
      - nodejs
      - openssl
      - pkg-config
      - protobuf-compiler
      - proxygen-dev
      - python
      - python-dev
      - python-pip
      - python-protobuf
      - python-rados
      - python-sphinx
      - python-xattr
      - python2.7-dev
      - python3
      - python3-dev
      - swift-sdk-cpp
      - unzip
      - uuid
      - uuid-dev
      - wangle-dev

script:
  - >
    mkdir -p release &&
    cd release &&
    export PKG_REVISION=$(git describe --tags --always --abbrev=7) &&
    export PKG_COMMIT=$(git rev-parse --verify HEAD) &&
    export HELPERS_COMMIT=$(git -C helpers rev-parse --verify HEAD) &&
    cmake -GNinja -DCMAKE_BUILD_TYPE=Release -DGIT_VERSION="$PKG_REVISION" -DGIT_COMMIT="$PKG_COMMIT" -DGIT_HELPERS_COMMIT="$HELPERS_COMMIT" -DCODE_COVERAGE=OFF -DWITH_CEPH=ON -DWITH_SWIFT=ON -DWITH_S3=ON -DWITH_GLUSTERFS=ON -DWITH_WEBDAV=ON -DWITH_ONEDATAFS=ON .. &&
    cd .. &&
    cmake --build release --target oneclient &&
    cmake --build release --target onebench &&
    cmake --build release --target onedatafs.py2 &&
    cmake --build release --target onedatafs.py3

after_script: set +e
